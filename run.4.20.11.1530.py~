import matplotlib
import matplotlib.pylab as pylab
execfile("/home/rumbaugh/FindCloseSources.py")
execfile("/home/rumbaugh/plotcircle.py")
execfile("/home/rumbaugh/angconvert.py")

html_purp = '#9933FF'
html_teal = '#33FFFF'
html_brwn = '#996600'
html_orng = '#FFCC00'

try:
    cradmult
except NameError:
    cradmult = 4

try:
    Ilim
except NameError:
    Ilim = 23.5
try:
    Imin
except NameError:
    Imin = 19.5

def switch5(arr5):
    arr5[0],arr5[1],arr5[2],arr5[3],arr5[4] = arr5[1],arr5[3],arr5[0],arr5[4],arr5[2]
    return arr5

path = '/home/rumbaugh/LFC'
pathm = '/scratch/rumbaugh/ciaotesting'
path2 = 'opt_match/opt_Xray_matched_catalog_3high.corrected.twk.dat'
names = np.array(['Cl1324','NEP5281','Cl0023','Cl1604','RXJ1757'])
files = np.array(['FINAL.cl1322.lrisplusdeimos.cat','FINAL.nep5281.deimos.gioia.feb2010.noheader.cat','FINAL.onlykindafinal.cl0023.deimos.lris.oct2010.cat','FINAL.spectra.sc1604.onlysemifinal.wcompletenessmasks.nov2010.noheader.cat','FINAL.spectroscopic.autocompile.N200.blemaux.nov2010.noheader.cat'])
mfiles = np.array(['FINAL.matched.1322.specnXray.nov2010.rumbaugh.cat','FINAL.matched.N5281.specnXray.nov2010.rumbaugh.cat','FINAL.matched.0023.specnXray.nov2010.rumbaugh.noheader.cat','FINAL.matched.1604.specnXray.nov2010.rumbaugh.noheader.cat','FINAL.matched.N200.specnXray.nov2010.rumbaugh.noheader.cat'])
pfiles=np.array(['sc1322.lfc.newIDsandoldIds.radecmag.cat','nep5281.lfc.newIDradecmag.cat','cl0023_radecIDmags.cat','final.idradecmag.lfcpluscosmic.withsdss.cat','nep200.idradecmag.lfc.uhcorr.neat'])

rsfitb = np.array([1.777,1.325,1.84,1.203,3.182])
rsfitm = np.array([0.0229,0.0084,0.0319,0.0012,0.063])
rsSTD = np.array([0.0625,0.0735,0.0576,0.0413,0.0907])
rsfitb = switch5(rsfitb)
rsfitm = switch5(rsfitm)
rsSTD = switch5(rsSTD)

rsNSTD = np.array([3.0,3.0,3.0,2.0,3.0])

zlb = np.array([0.66,0.808,0.82,0.84,0.68])
zub = np.array([0.785,0.828,0.856,0.96,0.705])

crcr = read_file('/home/rumbaugh/clusters.z+pos+mpc.4.18.11.dat')
struc = get_colvals(crcr,'col1')
cnam = get_colvals(crcr,'col2')
clusz = get_colvals(crcr,'col3')
clusRA = get_colvals(crcr,'col4')
clusDec = get_colvals(crcr,'col5')
mpc = get_colvals(crcr,'col6')
mpccm = get_colvals(crcr,'col7')
crads = cradmult*0.7*mpccm/60


Ilimholder = Ilim
Iminholder = Imin
for i in range(0,5):
    if i == 3: 
        Ilim = Ilimholder+1
        Imin = Iminholder+1
    else:
        Ilim = Ilimholder
        Imin = Iminholder
    rsfX = np.arange(15)+15
    rsfY1 = rsfitb[i]-rsfitm[i]*rsfX+rsNSTD[i]*rsSTD[i]
    rsfY2 = rsfitb[i]-rsfitm[i]*rsfX-rsNSTD[i]*rsSTD[i]

    master = 'master'
    if i == 2: master = '7914'
    mfile = '%s/%s/%s/%s'%(pathm,names[i],master,path2)
    sfile = '%s/%s'%(path,files[i])
    msfile = '%s/%s'%(path,mfiles[i])
    crm = read_file(mfile)
    mRAX = get_colvals(crm,'col2')
    mDecX = get_colvals(crm,'col3')
    nm = get_colvals(crm,'col5')
    mRA = get_colvals(crm,'col6')
    mDec = get_colvals(crm,'col7')

    pfile = '%s/%s'%(path,pfiles[i])
    crp = read_file(pfile)
    if i == 0:
        pRA = get_colvals(crp,'col3')
        pDec = get_colvals(crp,'col4')
        pR = get_colvals(crp,'col5')
        pI = get_colvals(crp,'col6')
        pZ = get_colvals(crp,'col7')
    else:
        pRA = get_colvals(crp,'col2')
        pDec = get_colvals(crp,'col3')
        pR = get_colvals(crp,'col4')
        pI = get_colvals(crp,'col5')
        pZ = get_colvals(crp,'col6')
    if i == 3:
        pfile2 = '/home/rumbaugh/LFC/ACS_merged.F606W+F814W_deep.all.coll.nh.dat'
        crp2 = read_file(pfile2)
        pR = get_colvals(crp2,'col3')
        pI = get_colvals(crp2,'col4')
        pRA = get_colvals(crp2,'col1')
        pDec = get_colvals(crp2,'col2')
        
    
    crs = read_file(sfile)
    sRA = get_colvals(crs,'col4')
    sDec = get_colvals(crs,'col5')
    sI = get_colvals(crs,'col7')
    sR = get_colvals(crs,'col6')
    sq = get_colvals(crs,'col11')
    sz = get_colvals(crs,'col9')
    if i == 3:
        sR = get_colvals(crs,'col17')
        sI = get_colvals(crs,'col18')
    
    crms = read_file(msfile)
    msRA = get_colvals(crms,'col4')
    msDec = get_colvals(crms,'col5')
    msR = get_colvals(crms,'col6')
    msI = get_colvals(crms,'col7')
    msZ = get_colvals(crms,'col8')
    msq = get_colvals(crms,'col11')
    msz = get_colvals(crms,'col9')
    msRAX = get_colvals(crms,'col14')
    msDecX = get_colvals(crms,'col15')

    gmsq = np.where(msq > 2.3)
    gmsq = gmsq[0]
    gmsz = np.where((msz[gmsq] >= zlb[i]) & (msz[gmsq] <= zub[i]))
    gmsz = gmsz[0]

    gnm = np.where(nm > 0.4)
    gnm = gnm[0]
    pInds = np.zeros(len(gnm),dtype='int')
    pInds.fill(-1)
    mInds = np.zeros(len(gnm),dtype='int')
    mInds.fill(-1)
    msInds = np.zeros(len(gnm),dtype='int')
    msInds.fill(-1)
    for j in range(0,len(gnm)):
        cic = FindCloseSources(mRA[gnm[j]],mDec[gnm[j]],1.8,sRA,sDec,0)
        if len(cic) > 0: mInds[j] = cic[0]
        cic3 = FindCloseSources(mRA[gnm[j]],mDec[gnm[j]],1.8,pRA,pDec,0)
        if len(cic3) > 0: pInds[j] = cic3[0]
        cic2 = FindCloseSources(mRAX[gnm[j]],mDecX[gnm[j]],1.8,msRA,msDec,0)
        if len(cic2) > 0: msInds[j] = cic2[0]
    ns = np.where(mInds > -0.3)
    ns = ns[0]
    gq = np.where((sq[mInds[ns]] == -1) | (sq[mInds[ns]] > 2.7))
    gq = gq[0]
    gq2 = np.where(sq[mInds[ns]] > 2.7)
    gq2 = gq2[0]
    gqz = np.where((sz[mInds[ns[gq2]]] >= zlb[i]) & (sz[mInds[ns[gq2]]] <= zub[i]))
    gqz = gqz[0]
    nwl = 0.0

    raA = msRA[gmsq[gmsz]]
    decA = msDec[gmsq[gmsz]]
    zA = msz[gmsq[gmsz]]
    rahA,ramA,rasA = np.zeros(len(gmsz)),np.zeros(len(gmsz)),np.zeros(len(gmsz))
    decdA,decmA,decsA = np.zeros(len(gmsz)),np.zeros(len(gmsz)),np.zeros(len(gmsz))
    garg = np.argsort(zA)
    argcnt = 0

    gsq = np.where((sq > 2.3))
    gsq = gsq[0]
    gsz = np.where((sz[gsq] >= zlb[i]) & (sz[gsq] <= zub[i]))
    gsz = gsz[0]
    nwl2 = 0.0
    gsI = np.where((sI <= Ilim) & (sI >= Imin))
    gsI = gsI[0]

    gt = np.where((pI <= Ilim) & (pI >= Imin))
    gt = gt[0]
    gt2 = np.where(pI[pInds] <= Ilim)
    gt2 = gt2[0]

    degree_symbol = unichr(176)
    indisS = np.zeros(len(gsI))

    if i == 0:
        #Cl1324
        inwin = np.where((pRA[gt] >= (13+(23.0+40.0/60)/60)*(360/24.0)) & (pRA[gt] <= (13+(25.0+30.0/60)/60)*(360/24.0)) & (pDec[gt] >= (30+5.0/60)) & (pDec[gt] <= 31 + 1.0/60))
        inwin = inwin[0]
        #dists = np.zeros((7,len(inwin)))
        indis = np.zeros(len(inwin))
        for j in range(0,7):
            for k in range(0,len(indisS)):
                if j < 5: 
                    diststemp = SphDist(clusRA[j+5],clusDec[j+5],sRA[gsI[k]],sDec[gsI[k]])
                    if diststemp < crads[j+5]*60: indisS[k] += 1
                if j == 5: 
                    diststemp = SphDist(13+(24.0+40.0/60)/60*360/24.0,30.0+49.0/60,sRA[gsI[k]],sDec[gsI[k]])
                    if diststemp < crads[5]*60*1.9: indisS[k] += 1
                if j == 6:
                    diststemp = SphDist(13+(24.0+43.0/60)/60*360/24.0,30.0+23.0/60,sRA[gsI[k]],sDec[gsI[k]])
                    if diststemp < crads[5]*60*1.3: indisS[k] += 1
            for k in range(0,len(inwin)):
                if j < 5: 
                    diststemp = SphDist(clusRA[j+5],clusDec[j+5],pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
                    if diststemp < crads[j+5]*60: indis[k] += 1
                if j == 5: 
                    diststemp = SphDist(13+(24.0+40.0/60)/60*360/24.0,30.0+49.0/60,pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
                    if diststemp < crads[5]*60*1.9: indis[k] += 1
                if j == 6:
                    diststemp = SphDist(13+(24.0+43.0/60)/60*360/24.0,30.0+23.0/60,pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
                    if diststemp < crads[5]*60*1.3: indis[k] += 1
    if i == 1:
        #NEP5281
        inwin = np.where((pRA[gt] >= (18+(20.0+30.0/60)/60)*(360/24.0)) & (pRA[gt] <= (18+(22.0+30.0/60)/60)*(360/24.0)) & (pDec[gt] >= (68+22.0/60)) & (pDec[gt] <= 68 + 34.0/60))
        inwin = inwin[0]
        indis = np.zeros(len(inwin))
        for k in range(0,len(indisS)):
            diststemp = SphDist(clusRA[4],clusDec[4],sRA[gsI[k]],sDec[gsI[k]])
            if diststemp < crads[4]*60: indisS[k] += 1
        for k in range(0,len(inwin)):
            diststemp = SphDist(clusRA[4],clusDec[4],pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
            if diststemp < crads[4]*60: indis[k] += 1
    if i == 2:
        #Cl0023
        inwin = np.where((pRA[gt] >= (0+(23.0+20.0/60)/60)*(360/24.0)) & (pRA[gt] <= (0+(24.0+30.0/60)/60)*(360/24.0)) & (pDec[gt] >= (4+16.0/60)) & (pDec[gt] <= 4 + 29.0/60))
        inwin = inwin[0]
        indis = np.zeros(len(inwin))
        for j in range(0,4):
            for k in range(0,len(indisS)):
                diststemp = SphDist(clusRA[j],clusDec[j],sRA[gsI[k]],sDec[gsI[k]])
                if diststemp < crads[j]*60: indisS[k] += 1
            for k in range(0,len(inwin)):
                diststemp = SphDist(clusRA[j],clusDec[j],pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
                if diststemp < crads[j]*60: indis[k] += 1
    if i == 3:
        #Cl1604
        inwin = np.where((pRA[gt] >= (16+(2.0+45.0/60)/60)*(360/24.0)) & (pRA[gt] <= (16+(5.0+15.0/60)/60)*(360/24.0)) & (pDec[gt] >= (43+0.0/60)) & (pDec[gt] <= 43 + 30.0/60))
        inwin = inwin[0]
        indis = np.zeros(len(inwin))
        for j in range(0,9):
            for k in range(0,len(indisS)):
                diststemp = SphDist(clusRA[j+10],clusDec[j+10],sRA[gsI[k]],sDec[gsI[k]])
                if diststemp < crads[j+10]*60: indisS[k] += 1
            for k in range(0,len(inwin)):
                diststemp = SphDist(clusRA[j+10],clusDec[j+10],pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
                if diststemp < crads[j+10]*60: indis[k] += 1
    if i == 4:
        #RXJ1757
        inwin = np.where((pRA[gt] >= (17+(56.0+40.0/60)/60)*(360/24.0)) & (pRA[gt] <= (17+(58.0+0.0/60)/60)*(360/24.0)) & (pDec[gt] >= (66+27.0/60)) & (pDec[gt] <= 66 + 36.0/60))
        inwin = inwin[0]
        indis = np.zeros(len(inwin))
        for k in range(0,len(indisS)):
            diststemp = SphDist(clusRA[len(clusRA)-1],clusDec[len(clusRA)-1],sRA[gsI[k]],sDec[gsI[k]])
            if diststemp < crads[len(clusRA)-1]*60: indisS[k] += 1
        for k in range(0,len(inwin)):
            diststemp = SphDist(clusRA[len(clusRA)-1],clusDec[len(clusRA)-1],pRA[gt[inwin[k]]],pDec[gt[inwin[k]]])
            if diststemp < crads[len(clusRA)-1]*60: indis[k] += 1
    inran = np.where(indis > 0.1)
    inran = inran[0]
    inranS = np.where(indisS > 0.1)
    inranS = inranS[0]
    gsgd = np.where(sq[gsI[inranS]] > 2.3)
    gsgd = gsgd[0]
    gsok = np.where((sq[gsI[inranS]] > 0.3) & (sq[gsI[inranS]] < 2.3))
    gsok = gsok[0]
    gsst = np.where(sq[gsI[inranS]] < -0.3)
    gsst = gsst[0]
    gsz = np.where((sz[gsI[inranS[gsgd]]] <= zub[i]) & (sz[gsI[inranS[gsgd]]] >= zlb[i]))
    pylab.xlim(19,25)
    pylab.ylim(-0.5,2.0)
    if i == 3:
        pylab.ylim(-0.5,2.5)
    pylab.scatter(pI[gt[inwin[inran]]],pR[gt[inwin[inran]]]-pI[gt[inwin[inran]]],s=6,color='blue')
    pylab.scatter(sI[gsI[inranS[gsst]]],sR[gsI[inranS[gsst]]]-sI[gsI[inranS[gsst]]],s=6.5,color=html_brwn)
    if len(gsok) > 0: pylab.scatter(sI[gsI[inranS[gsok]]],sR[gsI[inranS[gsok]]]-sI[gsI[inranS[gsok]]],s=6.5,color=html_teal)
    pylab.scatter(sI[gsI[inranS[gsgd]]],sR[gsI[inranS[gsgd]]]-sI[gsI[inranS[gsgd]]],s=7,color=html_orng)
    pylab.scatter(sI[gsI[inranS[gsgd[gsz]]]],sR[gsI[inranS[gsgd[gsz]]]]-sI[gsI[inranS[gsgd[gsz]]]],s=8,color='red')
    leg = pylab.legend(('No Spec','Q=-1','Q=1,2','Q=3,4','Q=3,4, in clus'),loc=4,markerscale=0.8,labelspacing=0.3)
    for t in leg.get_texts():
        t.set_fontsize('small')
    pylab.plot(rsfX,rsfY1,linestyle='dashed')
    pylab.plot(rsfX,rsfY2,linestyle='dashed')
    savname = '/home/rumbaugh/paperstuff/CMD.%s.completeness.4.20.11.png'%(names[i])
    pylab.savefig(savname)
    pylab.close('all')
    
    

